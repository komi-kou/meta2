<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆå‹•ä½œç¢ºèª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .loading { color: orange; }
        #detailTableContainer { min-height: 100px; background: #f5f5f5; padding: 10px; }
        canvas { max-width: 400px; max-height: 300px; }
    </style>
</head>
<body>
    <h1>ğŸ“ˆ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testAPI()">APIã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="apiResult"></div>
    </div>
    
    <div class="test-section">
        <h2>2. ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h2>
        <select id="campaignFilter">
            <option value="all">ã™ã¹ã¦ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
        </select>
        <select id="breakdownType">
            <option value="region">åœ°åŸŸåˆ¥</option>
            <option value="device_platform">ãƒ‡ãƒã‚¤ã‚¹åˆ¥</option>
        </select>
        <button onclick="loadDetailedReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
    </div>
    
    <div class="test-section">
        <h2>3. ã‚°ãƒ©ãƒ•è¡¨ç¤º</h2>
        <canvas id="regionChart" width="400" height="300"></canvas>
    </div>
    
    <div class="test-section">
        <h2>4. è©³ç´°ãƒ‡ãƒ¼ã‚¿</h2>
        <div id="detailTableContainer">
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5. çµ±è¨ˆæƒ…å ±</h2>
        <div>ç·åºƒå‘Šè²»: <span id="totalSpend">Â¥0</span></div>
        <div>ç·CVæ•°: <span id="totalConversions">0</span></div>
        <div>å¹³å‡CPA: <span id="avgCPA">Â¥0</span></div>
        <div>å¹³å‡CTR: <span id="avgCTR">0%</span></div>
    </div>
    
    <script>
        let reportData = null;
        let charts = {};
        
        // APIãƒ†ã‚¹ãƒˆ
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = '<div class="loading">ãƒ†ã‚¹ãƒˆä¸­...</div>';
            
            try {
                const response = await fetch('/api/detailed-report?campaign_id=all&period=last_7d');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="success">âœ… APIæ¥ç¶šæˆåŠŸ<br>
                        ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æ•°: ${data.campaignsAnalyzed}ä»¶<br>
                        ç·åºƒå‘Šè²»: Â¥${(data.statistics?.totalSpend || 0).toLocaleString()}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ APIã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆèª­ã¿è¾¼ã¿
        async function loadDetailedReport() {
            console.log('loadDetailedReporté–‹å§‹');
            const container = document.getElementById('detailTableContainer');
            container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            try {
                const campaignId = document.getElementById('campaignFilter').value;
                const breakdownType = document.getElementById('breakdownType').value;
                
                const response = await fetch(`/api/detailed-report?campaign_id=${campaignId}&period=last_7d&breakdown_type=${breakdownType}`);
                const data = await response.json();
                
                console.log('APIå¿œç­”:', data);
                
                if (data.success) {
                    reportData = data;
                    renderCharts();
                    updateStatistics();
                    renderDetailTable();
                } else {
                    container.innerHTML = `<div class="error">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                container.innerHTML = `<div class="error">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
            }
        }
        
        // ãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderCharts() {
            if (!reportData) return;
            
            const ctx = document.getElementById('regionChart');
            if (!ctx) return;
            
            if (charts.region) charts.region.destroy();
            
            const data = reportData.regionData || {};
            const labels = Object.keys(data).length > 0 ? Object.keys(data) : ['ãƒ‡ãƒ¼ã‚¿ãªã—'];
            const values = labels[0] === 'ãƒ‡ãƒ¼ã‚¿ãªã—' ? [1] : labels.map(label => data[label].impressions || 0);
            
            charts.region = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b']
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false
                }
            });
        }
        
        // çµ±è¨ˆæ›´æ–°
        function updateStatistics() {
            if (!reportData || !reportData.statistics) return;
            
            const stats = reportData.statistics;
            document.getElementById('totalSpend').textContent = 'Â¥' + (stats.totalSpend || 0).toLocaleString();
            document.getElementById('totalConversions').textContent = stats.totalConversions || 0;
            document.getElementById('avgCPA').textContent = 'Â¥' + (stats.avgCPA || 0).toLocaleString();
            document.getElementById('avgCTR').textContent = (stats.avgCTR || 0) + '%';
        }
        
        // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderDetailTable() {
            const container = document.getElementById('detailTableContainer');
            if (!container || !reportData) return;
            
            let html = '<table border="1" style="width:100%"><thead><tr>';
            html += '<th>ã‚«ãƒ†ã‚´ãƒª</th><th>åå‰</th><th>ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³</th><th>ã‚¯ãƒªãƒƒã‚¯</th><th>æ¶ˆåŒ–é¡</th>';
            html += '</tr></thead><tbody>';
            
            let hasData = false;
            
            // åœ°åŸŸãƒ‡ãƒ¼ã‚¿
            if (reportData.regionData) {
                Object.entries(reportData.regionData).forEach(([region, data]) => {
                    hasData = true;
                    html += `<tr>
                        <td>åœ°åŸŸ</td>
                        <td>${region}</td>
                        <td>${(data.impressions || 0).toLocaleString()}</td>
                        <td>${(data.clicks || 0).toLocaleString()}</td>
                        <td>Â¥${Math.round(data.spend || 0).toLocaleString()}</td>
                    </tr>`;
                });
            }
            
            // ãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿
            if (reportData.deviceData) {
                Object.entries(reportData.deviceData).forEach(([device, data]) => {
                    hasData = true;
                    html += `<tr>
                        <td>ãƒ‡ãƒã‚¤ã‚¹</td>
                        <td>${device}</td>
                        <td>${(data.impressions || 0).toLocaleString()}</td>
                        <td>${(data.clicks || 0).toLocaleString()}</td>
                        <td>Â¥${Math.round(data.spend || 0).toLocaleString()}</td>
                    </tr>`;
                });
            }
            
            html += '</tbody></table>';
            
            container.innerHTML = hasData ? html : '<div>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('load', () => {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿è¾¼ã¾ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰ï¼‰
        });
    </script>
</body>
</html>