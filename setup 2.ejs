<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆæœŸè¨­å®š - Metaåºƒå‘Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .setup-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        .setup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 40px 20px;
        }
        .setup-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .setup-header p {
            font-size: 18px;
            opacity: 0.9;
        }
        .progress-section {
            padding: 20px 40px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }
        .setup-content {
            padding: 40px;
        }
        .api-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }
        .api-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .api-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.1);
        }
        .api-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .api-card h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            margin-bottom: 20px;
            color: #1e293b;
            font-weight: 700;
        }
        .api-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        .meta-icon { background: #1877f2; }
        .chatwork-icon { background: #f39c12; }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        .form-group input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        .form-group small {
            display: block;
            margin-top: 6px;
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }
        .test-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }
        .test-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            display: block;
            white-space: pre-line; /* æ”¹è¡Œã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
            line-height: 1.5;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: block;
        }
        .status.loading {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
            display: block;
        }
        .goal-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }
        .goal-section h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            margin-bottom: 25px;
            color: #1e293b;
            font-weight: 700;
        }
        .goal-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        .goal-select {
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }
        .goal-select select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        .target-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .target-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .target-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        .target-card h4 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }
        .target-card input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }
        .target-card small {
            display: block;
            margin-top: 5px;
            color: #6b7280;
            font-size: 12px;
        }
        .notification-section {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
        }
        .notification-section h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            margin-bottom: 25px;
            color: #1e293b;
            font-weight: 700;
        }
        .notification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .notification-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
        }
        .notification-item h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: #1e293b;
            font-weight: 600;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .switch.active {
            background: #667eea;
        }
        .switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }
        .switch.active::before {
            transform: translateX(26px);
        }
        .time-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .submit-section {
            text-align: center;
            padding: 40px 0;
            border-top: 1px solid #e2e8f0;
        }
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s ease;
            min-width: 280px;
        }
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        .submit-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        @media (max-width: 768px) {
            .setup-content { padding: 20px; }
            .api-section { grid-template-columns: 1fr; gap: 20px; }
            .goal-grid { grid-template-columns: 1fr; }
            .target-values { grid-template-columns: 1fr; }
            .notification-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="setup-header">
            <h1>ğŸš€ åˆæœŸè¨­å®š</h1>
            <p>Metaåºƒå‘Šã®è‡ªå‹•åˆ†æãƒ»ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šçŸ¥ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†</p>
        </div>
        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div class="progress-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">è¨­å®šã‚’å®Œäº†ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†</div>
            <div class="progress-steps" id="progressSteps" style="display: none; margin-top: 15px; font-size: 12px; color: #64748b;">
                <div>ğŸ“Š Metaåºƒå‘ŠAPI: <span id="step-meta">æœªè¨­å®š</span></div>
                <div>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: <span id="step-chatwork">æœªè¨­å®š</span></div>
                <div>ğŸ”” é€šçŸ¥è¨­å®š: <span id="step-schedule">æœªè¨­å®š</span></div>
                <div>ğŸ¯ ç›®æ¨™è¨­å®š: <span id="step-goals">æœªè¨­å®š</span></div>
            </div>
        </div>
        <form method="POST" action="/save-setup" id="setupForm" class="setup-content">
            <!-- APIé€£æºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="api-section">
                <!-- Metaåºƒå‘ŠAPI -->
                <div class="api-card">
                    <h3>
                        <div class="api-icon meta-icon">ğŸ“Š</div>
                        Metaåºƒå‘ŠAPI
                    </h3>
                    <div class="form-group">
                        <label>ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³</label>
                        <input type="password" name="metaAccessToken" id="metaToken" required>
                        <small>Meta for Developers ã§å–å¾—ã—ãŸé•·æœŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                    </div>
                    <div class="form-group">
                        <label>åºƒå‘Šã‚¢ã‚«ã‚¦ãƒ³ãƒˆID</label>
                        <input type="text" name="metaAccountId" id="metaAccountId" placeholder="act_1234567890" required>
                        <small>åºƒå‘Šãƒãƒãƒ¼ã‚¸ãƒ£ã§ç¢ºèªã§ãã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆact_ã‚’å«ã‚€å½¢å¼ï¼‰</small>
                    </div>
                    <div class="form-group">
                        <label>ã‚¢ãƒ—ãƒªIDï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" name="metaAppId" id="metaAppId">
                        <small>Meta for Developers ã§ä½œæˆã—ãŸã‚¢ãƒ—ãƒªã®ID</small>
                    </div>
                    <button type="button" class="test-btn" onclick="testMetaAPI()">
                        <span>ğŸ”—</span> æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                    <div id="meta-status" class="status"></div>
                </div>
                <!-- ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯API -->
                <div class="api-card">
                    <h3>
                        <div class="api-icon chatwork-icon">ğŸ’¬</div>
                        ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€£æº
                    </h3>
                    <div class="form-group">
                        <label>APIãƒˆãƒ¼ã‚¯ãƒ³</label>
                        <input type="password" name="chatworkApiToken" id="chatworkToken" required>
                        <small>ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã€Œã‚µãƒ¼ãƒ“ã‚¹é€£æºã€ã§å–å¾—ã—ãŸAPIãƒˆãƒ¼ã‚¯ãƒ³</small>
                    </div>
                    <div class="form-group">
                        <label>ãƒ«ãƒ¼ãƒ ID</label>
                        <input type="text" name="chatworkRoomId" id="chatworkRoomId" required>
                        <small>é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ã®IDï¼ˆæ•°å­—ã®ã¿ï¼‰</small>
                    </div>
                    <div class="form-group">
                        <label>ãƒ«ãƒ¼ãƒ åï¼ˆç¢ºèªç”¨ï¼‰</label>
                        <input type="text" readonly placeholder="æ¥ç¶šãƒ†ã‚¹ãƒˆå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™" id="roomName">
                        <small>æ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã™ã‚‹ã¨ã€ãƒ«ãƒ¼ãƒ åãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                    </div>
                    <button type="button" class="test-btn" onclick="testChatwork()">
                        <span>ğŸ”—</span> æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                    <div id="chatwork-status" class="status"></div>
                </div>
            </div>
            <!-- ã‚´ãƒ¼ãƒ«è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="goal-section">
                <h3>
                    <span>ğŸ¯</span>
                    ã‚´ãƒ¼ãƒ«è¨­å®šãƒ»ç›®æ¨™æ•°å€¤
                </h3>
                <div class="goal-select">
                    <label>åºƒå‘Šã®ç›®çš„ãƒ»ã‚´ãƒ¼ãƒ«</label>
                    <select name="goal_type" id="goalType" onchange="updateTargetValues()" required>
                        <option value="">ã‚´ãƒ¼ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        <optgroup label="ğŸ‘¥ toCï¼ˆå€‹äººå‘ã‘ï¼‰">
                            <option value="toC_newsletter">ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬ç™»éŒ²</option>
                            <option value="toC_line">ğŸ“± LINEç™»éŒ²</option>
                            <option value="toC_phone">ğŸ“ é›»è©±ãƒœã‚¿ãƒ³</option>
                            <option value="toC_purchase">ğŸ›’ è³¼å…¥</option>
                        </optgroup>
                        <optgroup label="ğŸ¢ toBï¼ˆæ³•äººå‘ã‘ï¼‰">
                            <option value="toB_newsletter">ğŸ“§ ãƒ¡ãƒ«ãƒã‚¬ç™»éŒ²</option>
                            <option value="toB_line">ğŸ“± LINEç™»éŒ²</option>
                            <option value="toB_phone">ğŸ“ é›»è©±ãƒœã‚¿ãƒ³</option>
                            <option value="toB_purchase">ğŸ’¼ è³¼å…¥</option>
                        </optgroup>
                    </select>
                </div>
                <div class="target-values" id="targetValues">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
            <!-- é€šçŸ¥è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="notification-section">
                <h3>
                    <span>ğŸ””</span>
                    é€šçŸ¥è¨­å®š
                </h3>
                <div class="notification-grid">
                    <div class="notification-item">
                        <h4>ğŸ“ˆ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h4>
                        <div class="toggle-switch">
                            <div class="switch active" onclick="toggleSwitch(this)"></div>
                            <span>æ¯æ—¥ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</span>
                            <input type="hidden" name="daily_report_enabled" value="true">
                        </div>
                        <input type="time" name="daily_report_time" value="09:00" class="time-input">
                        <small>å‰æ—¥ã®åºƒå‘Šçµæœã‚’è©³ç´°ã«ãŠçŸ¥ã‚‰ã›ã—ã¾ã™</small>
                    </div>
                    <div class="notification-item">
                        <h4>ğŸ”„ æ›´æ–°é€šçŸ¥</h4>
                        <div class="toggle-switch">
                            <div class="switch active" onclick="toggleSwitch(this)"></div>
                            <span>å®šæœŸæ›´æ–°é€šçŸ¥</span>
                            <input type="hidden" name="update_notifications_enabled" value="true">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <input type="time" name="update_times" value="12:00" class="time-input">
                            <input type="time" name="update_times" value="15:00" class="time-input">
                            <input type="time" name="update_times" value="17:00" class="time-input">
                            <input type="time" name="update_times" value="19:00" class="time-input">
                        </div>
                        <small>æŒ‡å®šæ™‚é–“ã«ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™</small>
                    </div>
                    <div class="notification-item">
                        <h4>ğŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥</h4>
                        <div class="toggle-switch">
                            <div class="switch active" onclick="toggleSwitch(this)"></div>
                            <span>å³æ™‚ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥</span>
                            <input type="hidden" name="alert_notifications_enabled" value="true">
                        </div>
                        <small>è¨­å®šã—ãŸåŸºæº–ã‚’ä¸‹å›ã£ãŸéš›ã«å³åº§ã«é€šçŸ¥ã—ã¾ã™</small>
                    </div>
                </div>
            </div>
            <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <div class="submit-section">
                <button type="submit" class="submit-btn" id="submitBtn" disabled>
                    ğŸš€ è¨­å®šå®Œäº†ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹
                </button>
            </div>
        </form>
    </div>
    <script>
        // ã‚´ãƒ¼ãƒ«åˆ¥ç›®æ¨™æ•°å€¤è¨­å®šï¼ˆæ‹¡å¼µç‰ˆï¼‰
        const goalTargets = {
            toC_newsletter: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 1000, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 2.5, unit: '%', label: 'CTR' },
                cpm: { max: 1000, unit: 'å††', label: 'CPM' },
                cpa: { max: 2000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toC_line: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 1000, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 2.5, unit: '%', label: 'CTR' },
                cpm: { max: 800, unit: 'å††', label: 'CPM' },
                cpa: { max: 1000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toC_phone: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 1500, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 2.0, unit: '%', label: 'CTR' },
                cpm: { max: 1200, unit: 'å††', label: 'CPM' },
                cpa: { max: 3000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toC_purchase: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 2000, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 1.8, unit: '%', label: 'CTR' },
                cpm: { max: 1500, unit: 'å††', label: 'CPM' },
                cpa: { max: 5000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toB_newsletter: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 3000, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 1.5, unit: '%', label: 'CTR' },
                cpm: { max: 2000, unit: 'å††', label: 'CPM' },
                cpa: { max: 15000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toB_line: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 2500, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 1.5, unit: '%', label: 'CTR' },
                cpm: { max: 1800, unit: 'å††', label: 'CPM' },
                cpa: { max: 12000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toB_phone: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 4000, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 1.2, unit: '%', label: 'CTR' },
                cpm: { max: 2500, unit: 'å††', label: 'CPM' },
                cpa: { max: 20000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            },
            toB_purchase: {
                budgetRate: { min: 80, unit: '%', label: 'äºˆç®—æ¶ˆåŒ–ç‡' },
                dailyBudget: { min: 5000, unit: 'å††', label: 'æ—¥äºˆç®—' },
                ctr: { min: 1.0, unit: '%', label: 'CTR' },
                cpm: { max: 3000, unit: 'å††', label: 'CPM' },
                cpa: { max: 30000, unit: 'å††', label: 'CPA' },
                cv: { min: 1, unit: 'ä»¶/æ—¥', label: 'CV' }
            }
        };
        function updateTargetValues() {
            const goalType = document.getElementById('goalType').value;
            const container = document.getElementById('targetValues');
            if (!goalType || !goalTargets[goalType]) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; font-style: italic;">ã‚´ãƒ¼ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ç›®æ¨™æ•°å€¤ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                return;
            }
            const targets = goalTargets[goalType];
            container.innerHTML = '';
            Object.keys(targets).forEach(key => {
                const target = targets[key];
                const card = document.createElement('div');
                card.className = 'target-card';
                const minMax = target.min ? `æœ€å°: ${target.min}${target.unit}` : `æœ€å¤§: ${target.max}${target.unit}`;
                const defaultValue = target.min || target.max;
                card.innerHTML = `
                    <h4>${target.label}</h4>
                    <input type="number" name="target_${key}" value="${defaultValue}" step="0.1">
                    <small>${minMax}</small>
                `;
                container.appendChild(card);
            });
            updateProgress();
        }
        function toggleSwitch(element) {
            element.classList.toggle('active');
            const input = element.parentNode.querySelector('input[type="hidden"]');
            input.value = element.classList.contains('active') ? 'true' : 'false';
        }
        // è¨­å®šå®Œäº†çŠ¶æ³ã®è¨ˆç®—
        function calculateSetupProgress() {
            const steps = {
                metaApi: false,      // Metaåºƒå‘ŠAPIè¨­å®š
                chatwork: false,     // ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯APIè¨­å®š
                schedule: false,     // é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®š
                goals: false         // ç›®æ¨™è¨­å®š
            };
            
            // Meta APIè¨­å®šç¢ºèª
            if (document.getElementById('metaToken').value && 
                document.getElementById('metaAccountId').value) {
                steps.metaApi = true;
            }
            
            // ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯APIè¨­å®šç¢ºèª
            if (document.getElementById('chatworkToken').value && 
                document.getElementById('chatworkRoomId').value) {
                steps.chatwork = true;
            }
            
            // é€šçŸ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šç¢ºèª
            if (document.querySelector('input[name="daily_report_enabled"]:checked') ||
                document.querySelector('input[name="update_notifications_enabled"]:checked') ||
                document.querySelector('input[name="alert_notifications_enabled"]:checked')) {
                steps.schedule = true;
            }
            
            // ç›®æ¨™è¨­å®šç¢ºèª
            if (document.getElementById('goalType').value) {
                steps.goals = true;
            }
            
            // å®Œäº†æ¸ˆã¿ã‚¹ãƒ†ãƒƒãƒ—æ•°
            const completedSteps = Object.values(steps).filter(Boolean).length;
            const totalSteps = Object.keys(steps).length;
            const progressPercentage = Math.round((completedSteps / totalSteps) * 100);
            
            return {
                percentage: progressPercentage,
                completed: completedSteps,
                total: totalSteps,
                steps: steps
            };
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
        function updateProgressBar() {
            const progress = calculateSetupProgress();
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®DOMè¦ç´ ã‚’æ›´æ–°
            const progressBar = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressSteps = document.getElementById('progressSteps');
            
            if (progressBar) {
                progressBar.style.width = `${progress.percentage}%`;
            }
            
            if (progressText) {
                progressText.textContent = `è¨­å®šå®Œäº†: ${progress.percentage}% (${progress.completed}/${progress.total})`;
            }
            
            // ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°è¡¨ç¤ºã®æ›´æ–°
            if (progressSteps) {
                progressSteps.style.display = 'block';
                
                // å„ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’æ›´æ–°
                document.getElementById('step-meta').textContent = progress.steps.metaApi ? 'âœ… å®Œäº†' : 'â³ æœªå®Œäº†';
                document.getElementById('step-chatwork').textContent = progress.steps.chatwork ? 'âœ… å®Œäº†' : 'â³ æœªå®Œäº†';
                document.getElementById('step-schedule').textContent = progress.steps.schedule ? 'âœ… å®Œäº†' : 'â³ æœªå®Œäº†';
                document.getElementById('step-goals').textContent = progress.steps.goals ? 'âœ… å®Œäº†' : 'â³ æœªå®Œäº†';
            }
            
            // é€ä¿¡ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–
            const submitBtn = document.getElementById('submitBtn');
            if (progress.percentage >= 100) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ è¨­å®šå®Œäº†ï¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹';
                progressText.textContent = `âœ… å…¨è¨­å®šå®Œäº†ï¼é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ (${progress.percentage}%)`;
            } else if (progress.percentage >= 75) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ è¨­å®šå®Œäº†ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹';
                progressText.textContent = `âœ… è¨­å®šæº–å‚™å®Œäº†ï¼é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ (${progress.percentage}%)`;
            } else {
                submitBtn.disabled = true;
                submitBtn.textContent = 'ğŸš€ è¨­å®šå®Œäº†ã—ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹å§‹';
                progressText.textContent = `è¨­å®šå®Œäº†ã¾ã§ ${Math.round(100 - progress.percentage)}% ã§ã™ (${progress.completed}/${progress.total})`;
            }
            
            console.log('è¨­å®šé€²æ—æ›´æ–°:', progress);
            
            return progress;
        }

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ç›£è¦–
        function setupProgressTracking() {
            const inputFields = [
                'metaToken',
                'metaAccountId', 
                'chatworkToken',
                'chatworkRoomId',
                'goalType'
            ];
            
            inputFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', updateProgressBar);
                    field.addEventListener('change', updateProgressBar);
                }
            });
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ç›£è¦–
            const radioCheckboxes = document.querySelectorAll('input[type="radio"], input[type="checkbox"]');
            radioCheckboxes.forEach(input => {
                input.addEventListener('change', updateProgressBar);
            });
            
            // åˆæœŸãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¨ˆç®—
            updateProgressBar();
        }

        function updateProgress() {
            updateProgressBar();
        }
        async function testMetaAPI() {
            const token = document.getElementById('metaToken').value;
            const accountId = document.getElementById('metaAccountId').value;
            const status = document.getElementById('meta-status');
            const btn = event.target;
            
            if (!token || !accountId) {
                showStatus(status, 'error', 'âŒ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            btn.disabled = true;
            showStatus(status, 'loading', 'ğŸ”„ Meta APIæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
            
            try {
                const response = await fetch('/api/test-meta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, accountId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(status, 'success', `âœ… Meta APIæ¥ç¶šå®Œäº†ï¼\nã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ${result.data.name}\né€šè²¨: ${result.data.currency}\nã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: ${result.data.timezone}`);
                    // æ¥ç¶šæˆåŠŸæ™‚ã®ãƒãƒ¼ã‚¯è¿½åŠ 
                    btn.innerHTML = '<span>âœ…</span> æ¥ç¶šå®Œäº†';
                    btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                } else {
                    showStatus(status, 'error', `âŒ æ¥ç¶šå¤±æ•—: ${result.error}`);
                }
            } catch (error) {
                showStatus(status, 'error', 'âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                btn.disabled = false;
            }
        }
        async function testChatwork() {
            const token = document.getElementById('chatworkToken').value;
            const roomId = document.getElementById('chatworkRoomId').value;
            const status = document.getElementById('chatwork-status');
            const btn = event.target;
            
            if (!token || !roomId) {
                showStatus(status, 'error', 'âŒ APIãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            btn.disabled = true;
            showStatus(status, 'loading', 'ğŸ”„ ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
            
            try {
                const response = await fetch('/api/test-chatwork', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, roomId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('roomName').value = result.data.name || 'ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ';
                    showStatus(status, 'success', `âœ… ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šå®Œäº†ï¼\nãƒ«ãƒ¼ãƒ : ${result.data.name}\nã‚¿ã‚¤ãƒ—: ${result.data.type}\næ¨©é™: ${result.data.role}`);
                    // æ¥ç¶šæˆåŠŸæ™‚ã®ãƒãƒ¼ã‚¯è¿½åŠ 
                    btn.innerHTML = '<span>âœ…</span> æ¥ç¶šå®Œäº†';
                    btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                } else {
                    showStatus(status, 'error', `âŒ æ¥ç¶šå¤±æ•—: ${result.error}`);
                }
            } catch (error) {
                showStatus(status, 'error', 'âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            } finally {
                btn.disabled = false;
            }
        }
        function showStatus(element, type, message) {
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šçŸ¥é€ä¿¡æ©Ÿèƒ½
        async function sendChatworkNotification(messageType, data = {}) {
            try {
                const chatworkConfig = {
                    apiToken: document.getElementById('chatworkToken').value,
                    roomId: document.getElementById('chatworkRoomId').value
                };
                
                if (!chatworkConfig.apiToken || !chatworkConfig.roomId) {
                    throw new Error('ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šãŒä¸å®Œå…¨ã§ã™');
                }
                
                let message = '';
                
                switch (messageType) {
                    case 'daily_report':
                        message = generateDailyReportMessage(data);
                        break;
                    case 'update_notification':
                        message = generateUpdateNotificationMessage(data);
                        break;
                    case 'alert_notification':
                        message = generateAlertNotificationMessage(data);
                        break;
                    case 'token_expiry_warning':
                        message = generateTokenExpiryWarning();
                        break;
                    case 'setup_completion':
                        message = generateSetupCompletionMessage();
                        break;
                }
                
                const response = await fetch('/api/send-chatwork-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiToken: chatworkConfig.apiToken,
                        roomId: chatworkConfig.roomId,
                        message: message,
                        messageType: messageType
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šçŸ¥é€ä¿¡æˆåŠŸ');
                    return true;
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('âŒ ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šçŸ¥é€ä¿¡å¤±æ•—:', error);
                return false;
            }
        }

        // æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateDailyReportMessage(data) {
            const today = new Date().toLocaleDateString('ja-JP');
            
            return `[info][title]ğŸ“Š Metaåºƒå‘Š æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ - ${today}[/title]
ğŸ’° æ¶ˆåŒ–é‡‘é¡: ${data.spend?.toLocaleString() || 0}å††
ğŸ“ˆ äºˆç®—æ¶ˆåŒ–ç‡: ${data.budgetRate || 0}%
ğŸ‘† CTR: ${data.ctr || 0}%
ğŸ’µ CPM: ${data.cpm?.toLocaleString() || 0}å††
ğŸ¯ CVæ•°: ${data.conversions || 0}ä»¶
ğŸ’° CPA: ${data.cpa?.toLocaleString() || 0}å††
ğŸ”„ ãƒ•ãƒªãƒ¼ã‚¯ã‚¨ãƒ³ã‚·ãƒ¼: ${data.frequency || 0}

${data.budgetRate > 100 ? 'âš ï¸ äºˆç®—ã‚ªãƒ¼ãƒãƒ¼ã—ã¦ã„ã¾ã™' : 'âœ… äºˆç®—å†…ã§é‹ç”¨ä¸­'}
[/info]`;
        }

        // æ›´æ–°é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateUpdateNotificationMessage(data) {
            return `[info][title]ğŸ”„ Metaåºƒå‘Šãƒ‡ãƒ¼ã‚¿æ›´æ–°é€šçŸ¥[/title]
ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚

å‰å›ã¨ã®æ¯”è¼ƒ:
- æ¶ˆåŒ–é‡‘é¡: ${data.previousSpend || 0}å†† â†’ ${data.currentSpend || 0}å††
- CTR: ${data.previousCtr || 0}% â†’ ${data.currentCtr || 0}%
- CVæ•°: ${data.previousConversions || 0}ä»¶ â†’ ${data.currentConversions || 0}ä»¶

${data.improvements ? 'ğŸ“ˆ æ”¹å–„ç‚¹ãŒã‚ã‚Šã¾ã™' : 'ğŸ“Š ç¶™ç¶šã—ã¦ç›£è¦–ä¸­'}
[/info]`;
        }

        // æŠ€è¡“ç”¨èªã‚’æ—¥æœ¬èªã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function translateAlertTerms(alertText) {
            return alertText
                .replace(/budget_rate/g, 'äºˆç®—æ¶ˆåŒ–ç‡')
                .replace(/ctr/g, 'CTR')
                .replace(/conversions/g, 'CV')
                .replace(/cpa_rate/g, 'CPA')
                .replace(/cpm_increase/g, 'CPMä¸Šæ˜‡')
                .replace(/æ—¥äºˆç®—/g, 'æ—¥äºˆç®—')
                .replace(/CPM/g, 'CPM');
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateAlertNotificationMessage(data) {
            const today = new Date().toLocaleDateString('ja-JP');
            
            let message = `Metaåºƒå‘Š ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ (${today})
ä»¥ä¸‹ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ï¼š

`;

            if (data.alerts && data.alerts.length > 0) {
                data.alerts.forEach((alert, index) => {
                    const translatedMessage = translateAlertTerms(alert.message || alert);
                    const category = alert.metric || alert;
                    message += `${index + 1}. **${category}**ï¼š${translatedMessage}\n`;
                });
            }

            message += `
ç¢ºèªäº‹é …ï¼šhttp://localhost:3000/improvement-tasks
æ”¹å–„æ–½ç­–ï¼šhttp://localhost:3000/improvement-strategies

ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
http://localhost:3000/dashboard`;

            return message;
        }

        // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateTokenExpiryWarning() {
            return `[info][title]âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™è­¦å‘Š[/title]
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™1é€±é–“å‰ã§ã™ã€‚
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œã—ã¦ã€æœ‰åŠ¹æœŸé™ã‚’2ãƒ¶æœˆé–“ã«æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

â–¼ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ
https://developers.facebook.com/tools/explorer/

â–¼é•·æœŸã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œ
https://developers.facebook.com/tools/debug/accesstoken/

å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
[/info]`;
        }

        // è¨­å®šå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
        function generateSetupCompletionMessage() {
            return `[info][title]âœ… Metaåºƒå‘Šãƒ¬ãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«è¨­å®šå®Œäº†[/title]
Metaåºƒå‘Šãƒ¬ãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚

è¨­å®šå†…å®¹:
- Metaåºƒå‘ŠAPI: é€£æºæ¸ˆã¿
- ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šçŸ¥: æœ‰åŠ¹
- è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆ: è¨­å®šæ¸ˆã¿

ä»Šå¾Œã€å®šæœŸãƒ¬ãƒãƒ¼ãƒˆã¨ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ã‚’è‡ªå‹•é€ä¿¡ã„ãŸã—ã¾ã™ã€‚
[/info]`;
        }

        // è¨­å®šå®Œäº†æ™‚ã®å‡¦ç†
        async function handleSetupCompletion() {
            console.log('=== è¨­å®šå®Œäº†å‡¦ç† ===');
            
            try {
                const progress = calculateSetupProgress();
                
                if (progress.percentage === 100) {
                    console.log('âœ… å…¨è¨­å®šå®Œäº† - åˆå›é€šçŸ¥é€ä¿¡');
                    
                    // è¨­å®šå®Œäº†é€šçŸ¥é€ä¿¡
                    await sendChatworkNotification('setup_completion');
                    
                    console.log('âœ… åˆæœŸè¨­å®šé€šçŸ¥å®Œäº†');
                }
                
            } catch (error) {
                console.error('âŒ è¨­å®šå®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è¨­å®šå®Œäº†æ™‚ã®è‡ªå‹•é·ç§»å‡¦ç†
        async function showSetupCompleteMessage() {
            const progressText = document.getElementById('progressText');
            const submitBtn = document.getElementById('submitBtn');
            
            if (progressText) {
                progressText.textContent = 'âœ… è¨­å®šå®Œäº†ï¼ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¦ã„ã¾ã™...';
                progressText.style.color = '#10b981';
            }
            
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'ğŸš€ è¨­å®šå®Œäº† - è‡ªå‹•é·ç§»ä¸­...';
            }
            
            // 1.5ç§’å¾Œã«ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«é·ç§»
            setTimeout(() => {
                window.location.href = '/dashboard?setup_completed=true';
            }, 1500);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
        document.getElementById('setupForm').addEventListener('submit', async function(e) {
            const progress = calculateSetupProgress();
            
            if (progress.percentage >= 75) {
                // è¨­å®šå®Œäº†é€šçŸ¥ã‚’é€ä¿¡
                await handleSetupCompletion();
                
                // è¨­å®šå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã¨è‡ªå‹•é·ç§»
                showSetupCompleteMessage();
            } else {
                // è¨­å®šãŒä¸å®Œå…¨ãªå ´åˆã¯é€ä¿¡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                e.preventDefault();
                alert('è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°é–‹å§‹
        document.addEventListener('DOMContentLoaded', function() {
            setupProgressTracking();
            
            // æ—¢å­˜ã®è¨­å®šãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿
            loadExistingSettings();
        });

        // æ—¢å­˜è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadExistingSettings() {
            try {
                // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ—¢å­˜ã®å€¤ã‚’èª­ã¿è¾¼ã‚€
                fetch('/api/check-saved-meta-data')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.hasConfig) {
                            console.log('æ—¢å­˜è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                            updateProgressBar();
                        }
                    })
                    .catch(error => {
                        console.log('æ—¢å­˜è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
                    });
            } catch (error) {
                console.log('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
    </script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form[action="/save-setup"]');
  const submitBtn = document.querySelector('button[type="submit"]');
  if (form && submitBtn) {
    // æ—¢å­˜ã®è¤‡é›‘ãªåˆ¶å¾¡ã‚’ä¸Šæ›¸ã
    const newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    // ã‚·ãƒ³ãƒ—ãƒ«ãªé€ä¿¡å‡¦ç†ã«ç½®ãæ›ãˆ
    newForm.addEventListener('submit', function(e) {
      const metaToken = this.querySelector('input[name="metaAccessToken"]').value.trim();
      const metaAccount = this.querySelector('input[name="metaAccountId"]').value.trim();
      const chatworkToken = this.querySelector('input[name="chatworkApiToken"]').value.trim();
      const chatworkRoom = this.querySelector('input[name="chatworkRoomId"]').value.trim();
      if (!metaToken || !metaAccount || !chatworkToken || !chatworkRoom) {
        e.preventDefault();
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return false;
      }
      console.log('Form validation passed, submitting...');
      return true;
    });
    // ãƒœã‚¿ãƒ³ã‚’å¸¸ã«æœ‰åŠ¹åŒ–
    const newSubmitBtn = newForm.querySelector('button[type="submit"]');
    newSubmitBtn.disabled = false;
    newSubmitBtn.removeAttribute('disabled');
  }
  // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹åˆ¶å¾¡ã®ç„¡åŠ¹åŒ–
  if (typeof progress !== 'undefined') {
    progress.percentage = 100;
  }
  // showSetupCompleteMessageé–¢æ•°ã‚’ç„¡åŠ¹åŒ–
  if (typeof showSetupCompleteMessage === 'function') {
    window.showSetupCompleteMessage = function() {
      console.log('Setup complete message triggered');
    };
  }
  // ãƒœã‚¿ãƒ³ã®å¼·åˆ¶æœ‰åŠ¹åŒ–
  setTimeout(function() {
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.removeAttribute('disabled');
    }
  }, 500);
});
</script>
<div style="margin-top: 20px; padding: 10px; border: 2px solid #ff6b6b; background: #ffe0e0; border-radius: 8px;">
  <h4 style="color: #d63031; margin: 0 0 10px 0;">ğŸ”§ ç·Šæ€¥ãƒ‡ãƒãƒƒã‚°ç”¨</h4>
  <p style="font-size: 14px; margin: 0 0 10px 0;">è¨­å®šå®Œäº†ãƒœã‚¿ãƒ³ãŒå‹•ä½œã—ãªã„å ´åˆã¯ã€ã“ã¡ã‚‰ã‚’ãŠè©¦ã—ãã ã•ã„</p>
  <button type="button" onclick="forceFormSubmit()" style="
    background: #00b894; 
    color: white; 
    border: none; 
    padding: 12px 24px; 
    border-radius: 6px; 
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
  ">
    ğŸš€ å¼·åˆ¶é€ä¿¡ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  </button>
</div>
<script>
function forceFormSubmit() {
  console.log('Force submit triggered');
  const metaToken = document.querySelector('input[name="metaAccessToken"]').value;
  const metaAccount = document.querySelector('input[name="metaAccountId"]').value;
  const chatworkToken = document.querySelector('input[name="chatworkApiToken"]').value;
  const chatworkRoom = document.querySelector('input[name="chatworkRoomId"]').value;
  console.log('Form data:', {metaToken, metaAccount, chatworkToken, chatworkRoom});
  if (!metaToken || !metaAccount || !chatworkToken || !chatworkRoom) {
    alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const formData = new FormData();
  formData.append('metaAccessToken', metaToken);
  formData.append('metaAccountId', metaAccount);
  formData.append('chatworkApiToken', chatworkToken);
  formData.append('chatworkRoomId', chatworkRoom);
  console.log('Sending POST request to /save-setup');
  fetch('/save-setup', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    console.log('Response status:', response.status);
    if (response.redirected) {
      console.log('Redirected to:', response.url);
      window.location.href = response.url;
    } else if (response.ok) {
      console.log('Success, redirecting to dashboard');
      window.location.href = '/dashboard';
    } else {
      console.error('Error response:', response);
      alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  })
  .catch(error => {
    console.error('Fetch error:', error);
    alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
  });
}
</script>

<div style="margin-top: 20px; padding: 10px; border: 2px solid #0984e3; background: #e3f2fd; border-radius: 8px;">
  <h4 style="color: #0984e3; margin: 0 0 10px 0;">âš¡ è¶…ç°¡å˜é€ä¿¡</h4>
  <button type="button" onclick="simpleSubmit()" style="
    background: #0984e3; 
    color: white; 
    border: none; 
    padding: 12px 24px; 
    border-radius: 6px; 
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
  ">
    âš¡ ç°¡å˜é€ä¿¡
  </button>
</div>
<script>
function simpleSubmit() {
  const metaToken = document.querySelector('input[name="metaAccessToken"]').value;
  const metaAccount = document.querySelector('input[name="metaAccountId"]').value;
  const chatworkToken = document.querySelector('input[name="chatworkApiToken"]').value;
  const chatworkRoom = document.querySelector('input[name="chatworkRoomId"]').value;
  if (!metaToken || !metaAccount || !chatworkToken || !chatworkRoom) {
    alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const params = new URLSearchParams({
    metaAccessToken: metaToken,
    metaAccountId: metaAccount,
    chatworkApiToken: chatworkToken,
    chatworkRoomId: chatworkRoom,
    method: 'simple'
  });
  window.location.href = '/save-setup-get?' + params.toString();
}
</script>
</body>
</html> 