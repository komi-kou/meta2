<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æ - Metaåºƒå‘Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .sidebar-nav {
            padding: 10px 0;
        }
        
        .nav-item {
            display: block;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #fff;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .content-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title {
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-selector input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .date-selector button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .date-selector button:hover {
            background: #5a6dc8;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .detail-table {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .metric-value {
            font-weight: 600;
        }
        
        .metric-positive {
            color: #27ae60;
        }
        
        .metric-negative {
            color: #e74c3c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .sidebar-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            padding: 0 20px;
        }
        
        .insights-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .insight-item {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 4px;
        }
        
        .insight-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .insight-description {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆçµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Metaåºƒå‘Šãƒ¬ãƒãƒ¼ãƒˆ</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <a href="/campaigns" class="nav-item">ğŸ“Š ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç®¡ç†</a>
                <a href="/ad-performance" class="nav-item">ğŸ¯ åºƒå‘Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</a>
                <a href="/audience-analysis" class="nav-item active">ğŸ‘¥ ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æ</a>
                <a href="/multi-account" class="nav-item">ğŸ”„ ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a>
                <a href="/budget-scheduling" class="nav-item">â° äºˆç®—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°</a>
                <a href="/alerts" class="nav-item" id="alerts-link">ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹</a>
                <a href="/alert-history" class="nav-item">ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´</a>
                <a href="/improvement-tasks" class="nav-item">ç¢ºèªäº‹é …</a>
                <a href="/improvement-strategies" class="nav-item">æ”¹å–„æ–½ç­–</a>
            
            <div class="sidebar-footer">
                <form action="/logout" method="POST" style="margin: 0;">
                    <button type="submit" class="nav-item" style="
                        display: block;
                        width: 100%;
                        padding: 12px 20px;
                        background: rgba(231, 76, 60, 0.1);
                        color: #e74c3c;
                        border: 1px solid rgba(231, 76, 60, 0.2);
                        border-radius: 5px;
                        text-align: left;
                        cursor: pointer;
                        transition: all 0.3s;
                        font-size: 14px;
                        font-weight: 500;
                    " onmouseover="this.style.background='rgba(231, 76, 60, 0.2)'" onmouseout="this.style.background='rgba(231, 76, 60, 0.1)'">
                        ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </form>
            </div>
        </div>
        
        <div class="main-content">
            <div class="content-header">
                <h1 class="content-title">ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æ</h1>
                <div class="date-selector">
                    <input type="date" id="dateFrom" />
                    <span>ã€œ</span>
                    <input type="date" id="dateTo" />
                    <button onclick="loadAudienceData()">æ›´æ–°</button>
                </div>
            </div>
            
            <!-- ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="insights-section" id="insightsSection">
                <h3 class="table-title">ä¸»è¦ã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h3>
                <div id="insightsContainer">
                    <div class="loading">ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’åˆ†æä¸­...</div>
                </div>
            </div>
            
            <!-- ãƒãƒ£ãƒ¼ãƒˆã‚°ãƒªãƒƒãƒ‰ -->
            <div class="analysis-grid">
                <div class="chart-card">
                    <h4 class="chart-title">å¹´é½¢åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
                    <canvas id="ageChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4 class="chart-title">æ€§åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
                    <canvas id="genderChart"></canvas>
                </div>
                <div class="chart-card">
                    <h4 class="chart-title">ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
                    <canvas id="deviceChart"></canvas>
                </div>
            </div>
            
            <!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="detail-table">
                <h3 class="table-title">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
                
                <h4 style="margin-top: 30px;">å¹´é½¢åˆ¥</h4>
                <table id="ageTable">
                    <thead>
                        <tr>
                            <th>å¹´é½¢å±¤</th>
                            <th>æ¶ˆåŒ–é¡</th>
                            <th>ã‚¯ãƒªãƒƒã‚¯</th>
                            <th>CV</th>
                            <th>CTR</th>
                            <th>CPA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
                
                <h4 style="margin-top: 30px;">æ€§åˆ¥</h4>
                <table id="genderTable">
                    <thead>
                        <tr>
                            <th>æ€§åˆ¥</th>
                            <th>æ¶ˆåŒ–é¡</th>
                            <th>ã‚¯ãƒªãƒƒã‚¯</th>
                            <th>CV</th>
                            <th>CTR</th>
                            <th>CPA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
                
                <h4 style="margin-top: 30px;">ãƒ‡ãƒã‚¤ã‚¹åˆ¥</h4>
                <table id="deviceTable">
                    <thead>
                        <tr>
                            <th>ãƒ‡ãƒã‚¤ã‚¹</th>
                            <th>æ¶ˆåŒ–é¡</th>
                            <th>ã‚¯ãƒªãƒƒã‚¯</th>
                            <th>CV</th>
                            <th>CTR</th>
                            <th>CPA</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- ãƒ•ã‚¡ãƒãƒ«åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="detail-table" style="margin-top: 30px;">
                <h3 class="table-title">ãƒ•ã‚¡ãƒãƒ«åˆ†æ</h3>
                <canvas id="funnelChart" style="max-height: 400px;"></canvas>
                <div id="funnelTableContainer" style="margin-top: 20px;">
                    <div class="loading">ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let audienceData = null;
        let funnelData = null;
        let charts = {};
        
        // åˆæœŸè¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’è¨­å®šï¼ˆéå»7æ—¥é–“ï¼‰
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadAudienceData();
            loadFunnelData();
        });
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAudienceData() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            try {
                const response = await fetch(`/api/audience-insights?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    audienceData = data.data;
                    // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã‹ãƒã‚§ãƒƒã‚¯
                    if (Object.keys(audienceData.byAge || {}).length > 0 ||
                        Object.keys(audienceData.byGender || {}).length > 0 ||
                        Object.keys(audienceData.byDevice || {}).length > 0) {
                        renderCharts();
                        renderTables();
                        renderInsights();
                    } else {
                        showError('Meta APIã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚æœ‰åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                    }
                } else if (data.error) {
                    showError(`ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“: ${data.error}`);
                }
            } catch (error) {
                console.error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showError('ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadFunnelData() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            try {
                const response = await fetch(`/api/funnel-analysis?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success) {
                    funnelData = data.data;
                    renderFunnelChart();
                    renderFunnelTable();
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderCharts() {
            if (!audienceData) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // å¹´é½¢åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
            const ageCtx = document.getElementById('ageChart').getContext('2d');
            charts.age = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(audienceData.byAge || {}),
                    datasets: [
                        {
                            label: 'æ¶ˆåŒ–é¡',
                            data: Object.values(audienceData.byAge || {}).map(d => d.spend),
                            backgroundColor: '#667eea',
                            yAxisID: 'y'
                        },
                        {
                            label: 'CPA',
                            data: Object.values(audienceData.byAge || {}).map(d => d.cpa),
                            type: 'line',
                            borderColor: '#ec4899',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ¶ˆåŒ–é¡ (Â¥)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'CPA (Â¥)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
            // æ€§åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            const genderLabels = Object.keys(audienceData.byGender || {}).map(g => 
                g === 'male' ? 'ç”·æ€§' : g === 'female' ? 'å¥³æ€§' : g
            );
            
            charts.gender = new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: genderLabels,
                    datasets: [{
                        data: Object.values(audienceData.byGender || {}).map(d => d.spend),
                        backgroundColor: ['#667eea', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: Â¥${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            const deviceLabels = Object.keys(audienceData.byDevice || {}).map(d => 
                d === 'mobile' ? 'ãƒ¢ãƒã‚¤ãƒ«' : d === 'desktop' ? 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—' : d
            );
            
            charts.device = new Chart(deviceCtx, {
                type: 'pie',
                data: {
                    labels: deviceLabels,
                    datasets: [{
                        data: Object.values(audienceData.byDevice || {}).map(d => d.spend),
                        backgroundColor: ['#667eea', '#a855f7', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTables() {
            if (!audienceData) return;
            
            // å¹´é½¢åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
            renderSegmentTable('ageTable', audienceData.byAge);
            
            // æ€§åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
            const genderData = {};
            Object.entries(audienceData.byGender || {}).forEach(([key, value]) => {
                const label = key === 'male' ? 'ç”·æ€§' : key === 'female' ? 'å¥³æ€§' : key;
                genderData[label] = value;
            });
            renderSegmentTable('genderTable', genderData);
            
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«
            const deviceData = {};
            Object.entries(audienceData.byDevice || {}).forEach(([key, value]) => {
                const label = key === 'mobile' ? 'ãƒ¢ãƒã‚¤ãƒ«' : key === 'desktop' ? 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—' : key;
                deviceData[label] = value;
            });
            renderSegmentTable('deviceTable', deviceData);
        }
        
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderSegmentTable(tableId, data) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            
            if (!data || Object.keys(data).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            let html = '';
            Object.entries(data).forEach(([key, value]) => {
                const cpaClass = value.cpa > 1000 ? 'metric-negative' : 'metric-positive';
                html += `
                    <tr>
                        <td>${key}</td>
                        <td class="metric-value">Â¥${(value.spend || 0).toLocaleString()}</td>
                        <td>${(value.clicks || 0).toLocaleString()}</td>
                        <td class="metric-value">${value.conversions || 0}</td>
                        <td>${(value.ctr || 0).toFixed(2)}%</td>
                        <td class="metric-value ${cpaClass}">Â¥${Math.round(value.cpa || 0).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // ã‚¤ãƒ³ã‚µã‚¤ãƒˆæç”»
        function renderInsights() {
            if (!audienceData) return;
            
            const container = document.getElementById('insightsContainer');
            let insights = [];
            
            // æœ€é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å¹´é½¢å±¤ï¼ˆCPA > 0ã®ã¿è€ƒæ…®ï¼‰
            const ageWithConversions = Object.entries(audienceData.byAge || {})
                .filter(([age, data]) => data.conversions > 0 && data.cpa > 0);
            
            if (ageWithConversions.length > 0) {
                const bestAge = ageWithConversions.reduce((best, [age, data]) => {
                    if (!best || data.cpa < best.cpa) {
                        return { age, ...data };
                    }
                    return best;
                }, null);
                
                if (bestAge) {
                    insights.push({
                        title: 'æœ€é«˜åŠ¹ç‡ã®å¹´é½¢å±¤',
                        description: `${bestAge.age}æ­³ãŒæœ€ã‚‚åŠ¹ç‡çš„ã§ã™ï¼ˆCPA: Â¥${Math.round(bestAge.cpa).toLocaleString()}ã€CV: ${bestAge.conversions}ä»¶ï¼‰`
                    });
                }
            }
            
            // ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ0ã®å¹´é½¢å±¤ã®è­¦å‘Š
            const ageNoConversions = Object.entries(audienceData.byAge || {})
                .filter(([age, data]) => data.spend > 0 && data.conversions === 0);
            
            if (ageNoConversions.length > 0) {
                const totalSpendNoCV = ageNoConversions.reduce((sum, [age, data]) => sum + data.spend, 0);
                const ageGroups = ageNoConversions.map(([age]) => age).join('ã€');
                insights.push({
                    title: 'âš ï¸ ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æœªç™ºç”Ÿã®å¹´é½¢å±¤',
                    description: `${ageGroups}æ­³ã§CVæœªç™ºç”Ÿï¼ˆæ¶ˆåŒ–é¡: Â¥${Math.round(totalSpendNoCV).toLocaleString()}ï¼‰ã€‚ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ã‚„åºƒå‘Šå†…å®¹ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`
                });
            }
            
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®æ¨å¥¨
            const mobileData = audienceData.byDevice?.mobile || audienceData.byDevice?.mobile_app;
            const desktopData = audienceData.byDevice?.desktop;
            if (mobileData && desktopData) {
                const mobileRatio = mobileData.spend / (mobileData.spend + desktopData.spend) * 100;
                if (mobileRatio > 80) {
                    insights.push({
                        title: 'ãƒ¢ãƒã‚¤ãƒ«ä¸­å¿ƒã®é…ä¿¡',
                        description: `é…ä¿¡ã®${mobileRatio.toFixed(0)}%ãŒãƒ¢ãƒã‚¤ãƒ«ã§ã™ã€‚ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã‚’é‡ç‚¹çš„ã«è¡Œã„ã¾ã—ã‚‡ã†ã€‚`
                    });
                }
                
                // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ
                if (mobileData.conversions > 0 && desktopData.conversions > 0) {
                    if (mobileData.cpa < desktopData.cpa * 0.8) {
                        insights.push({
                            title: 'ãƒ¢ãƒã‚¤ãƒ«ãŒåŠ¹ç‡çš„',
                            description: `ãƒ¢ãƒã‚¤ãƒ«ã®CPAï¼ˆÂ¥${Math.round(mobileData.cpa).toLocaleString()}ï¼‰ãŒãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚ˆã‚Š20%ä»¥ä¸Šä½ã„ã§ã™ã€‚`
                        });
                    } else if (desktopData.cpa < mobileData.cpa * 0.8) {
                        insights.push({
                            title: 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãŒåŠ¹ç‡çš„',
                            description: `ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®CPAï¼ˆÂ¥${Math.round(desktopData.cpa).toLocaleString()}ï¼‰ãŒãƒ¢ãƒã‚¤ãƒ«ã‚ˆã‚Š20%ä»¥ä¸Šä½ã„ã§ã™ã€‚`
                        });
                    }
                }
            }
            
            // æ€§åˆ¥ã«ã‚ˆã‚‹å·®ç•°ï¼ˆCPA > 0ã®ã¿æ¯”è¼ƒï¼‰
            const maleData = audienceData.byGender?.male;
            const femaleData = audienceData.byGender?.female;
            if (maleData && femaleData) {
                // ä¸¡æ–¹ã«ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿CPAæ¯”è¼ƒ
                if (maleData.conversions > 0 && femaleData.conversions > 0) {
                    if (maleData.cpa < femaleData.cpa * 0.8) {
                        insights.push({
                            title: 'ç”·æ€§å‘ã‘ãŒåŠ¹ç‡çš„',
                            description: `ç”·æ€§ã®CPAï¼ˆÂ¥${Math.round(maleData.cpa).toLocaleString()}ï¼‰ãŒå¥³æ€§ã‚ˆã‚Š20%ä»¥ä¸Šä½ã„ã§ã™ã€‚ç”·æ€§å‘ã‘ã®é…ä¿¡ã‚’å¼·åŒ–ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`
                        });
                    } else if (femaleData.cpa < maleData.cpa * 0.8) {
                        insights.push({
                            title: 'å¥³æ€§å‘ã‘ãŒåŠ¹ç‡çš„',
                            description: `å¥³æ€§ã®CPAï¼ˆÂ¥${Math.round(femaleData.cpa).toLocaleString()}ï¼‰ãŒç”·æ€§ã‚ˆã‚Š20%ä»¥ä¸Šä½ã„ã§ã™ã€‚å¥³æ€§å‘ã‘ã®é…ä¿¡ã‚’å¼·åŒ–ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚`
                        });
                    }
                } else if (maleData.conversions > 0 && femaleData.conversions === 0) {
                    insights.push({
                        title: 'ç”·æ€§ã®ã¿ã§CVç™ºç”Ÿ',
                        description: `ç”·æ€§ã§ã®ã¿CVç™ºç”Ÿï¼ˆ${maleData.conversions}ä»¶ï¼‰ã€‚å¥³æ€§å‘ã‘ã®ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`
                    });
                } else if (femaleData.conversions > 0 && maleData.conversions === 0) {
                    insights.push({
                        title: 'å¥³æ€§ã®ã¿ã§CVç™ºç”Ÿ',
                        description: `å¥³æ€§ã§ã®ã¿CVç™ºç”Ÿï¼ˆ${femaleData.conversions}ä»¶ï¼‰ã€‚ç”·æ€§å‘ã‘ã®ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã‚„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`
                    });
                }
            }
            
            // å…¨ä½“çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Š
            const totalSpend = Object.values(audienceData.byAge || {}).reduce((sum, data) => sum + data.spend, 0);
            const totalConversions = Object.values(audienceData.byAge || {}).reduce((sum, data) => sum + data.conversions, 0);
            
            if (totalSpend > 10000 && totalConversions === 0) {
                insights.push({
                    title: 'ğŸš¨ ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ”¹å–„ãŒæ€¥å‹™',
                    description: `æ¶ˆåŒ–é¡Â¥${Math.round(totalSpend).toLocaleString()}ã§CV0ä»¶ã§ã™ã€‚ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã€ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ã€åºƒå‘Šã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã®ç·åˆçš„ãªè¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚`
                });
            }
            
            if (insights.length === 0) {
                insights.push({
                    title: 'åˆ†æä¸­',
                    description: 'ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­ã§ã™ã€‚ã‚ˆã‚Šå¤šãã®ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã‚‹ã¨ã€è©³ç´°ãªã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'
                });
            }
            
            let html = '';
            insights.forEach(insight => {
                html += `
                    <div class="insight-item">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderFunnelChart() {
            if (!funnelData || !funnelData.funnel) return;
            
            const ctx = document.getElementById('funnelChart').getContext('2d');
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
            if (charts.funnel) {
                charts.funnel.destroy();
            }
            
            charts.funnel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funnelData.funnel.stages.map(s => s.name),
                    datasets: [{
                        label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°',
                        data: funnelData.funnel.stages.map(s => s.count),
                        backgroundColor: funnelData.funnel.stages.map((s, i) => {
                            const opacity = 1 - (i * 0.15);
                            return `rgba(102, 126, 234, ${opacity})`;
                        })
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const stage = funnelData.funnel.stages[context.dataIndex];
                                    return `${stage.count.toLocaleString()}äºº (${stage.rate}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderFunnelTable() {
            const container = document.getElementById('funnelTableContainer');
            
            if (!funnelData || !funnelData.funnel) {
                container.innerHTML = '<div class="loading">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<h4>é›¢è„±ãƒã‚¤ãƒ³ãƒˆåˆ†æ</h4><table><thead><tr><th>ã‚¹ãƒ†ãƒ¼ã‚¸</th><th>é›¢è„±ç‡</th><th>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th></tr></thead><tbody>';
            
            funnelData.funnel.dropoffPoints.forEach(point => {
                const isHighDropoff = point.dropoffRate > 50;
                const recommendation = getDropoffRecommendation(point.stage, point.dropoffRate);
                html += `
                    <tr>
                        <td>${point.stage}</td>
                        <td class="${isHighDropoff ? 'metric-negative' : ''}">${point.dropoffRate.toFixed(1)}%</td>
                        <td style="font-size: 13px; color: #666;">${recommendation}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // é›¢è„±ç‡ã«åŸºã¥ãæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ±ç”¨ãƒ•ã‚¡ãƒãƒ«å¯¾å¿œï¼‰
        function getDropoffRecommendation(stage, dropoffRate) {
            if (stage.includes('ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³â†’ã‚¯ãƒªãƒƒã‚¯')) {
                if (dropoffRate > 99) {
                    return 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ã®æ”¹å–„ã€ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°ã®è¦‹ç›´ã—ã€CTAã®æ˜ç¢ºåŒ–';
                } else if (dropoffRate > 95) {
                    return 'ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã®é­…åŠ›åº¦å‘ä¸Šã€åºƒå‘Šæ–‡ã®æœ€é©åŒ–';
                } else {
                    return 'è‰¯å¥½ - ç¾çŠ¶ç¶­æŒ';
                }
            } else if (stage.includes('ã‚¯ãƒªãƒƒã‚¯â†’ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼')) {
                if (dropoffRate > 50) {
                    return 'ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿é€Ÿåº¦æ”¹å–„ã€ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–';
                } else if (dropoffRate > 30) {
                    return 'ãƒšãƒ¼ã‚¸è¡¨ç¤ºé€Ÿåº¦ã®ç¢ºèªã€ãƒªãƒ³ã‚¯å…ˆURLã®æ¤œè¨¼';
                } else {
                    return 'è‰¯å¥½ - ç¾çŠ¶ç¶­æŒ';
                }
            } else if (stage.includes('ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼â†’ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ') || stage.includes('ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ')) {
                if (dropoffRate > 70) {
                    return 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è³ªæ”¹å–„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Šã€CTAé…ç½®ã®æœ€é©åŒ–';
                } else if (dropoffRate > 50) {
                    return 'ãƒšãƒ¼ã‚¸å†…ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å……å®Ÿã€å‹•ç”»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¿½åŠ ';
                } else {
                    return 'è‰¯å¥½ - ç¾çŠ¶ç¶­æŒ';
                }
            } else if (stage.includes('ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³')) {
                if (dropoffRate > 95) {
                    return 'ãƒ•ã‚©ãƒ¼ãƒ ç°¡ç´ åŒ–ã€å…¥åŠ›é …ç›®å‰Šæ¸›ã€ä¿¡é ¼æ€§å‘ä¸Šæ–½ç­–';
                } else if (dropoffRate > 90) {
                    return 'ã‚ªãƒ•ã‚¡ãƒ¼ã®é­…åŠ›åº¦å‘ä¸Šã€é™å®šæ„Ÿã®æ¼”å‡º';
                } else {
                    return 'è‰¯å¥½ - ç¶™ç¶šçš„ãªæ”¹å–„ã‚’æ¨å¥¨';
                }
            } else {
                return 'ç¶™ç¶šçš„ãªç›£è¦–ã‚’æ¨å¥¨';
            }
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            console.error(message);
            // ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒŠã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const insightsContainer = document.getElementById('insightsContainer');
            if (insightsContainer) {
                insightsContainer.innerHTML = `
                    <div class="insight-item" style="border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.1);">
                        <div class="insight-title">âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼</div>
                        <div class="insight-description">${message}</div>
                    </div>
                `;
            }
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã«ã‚‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const containers = ['ageTable', 'genderTable', 'deviceTable'].map(id => 
                document.querySelector(`#${id} tbody`)
            );
            containers.forEach(container => {
                if (container) {
                    container.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #999;">${message}</td></tr>`;
                }
            });
        }
    </script>
</body>
</html>