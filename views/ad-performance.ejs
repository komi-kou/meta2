<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åºƒå‘Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´° - Metaåºƒå‘Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f6fa;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 20px;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .sidebar-nav {
            padding: 10px 0;
        }
        
        .nav-item {
            display: block;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            position: relative;
        }
        
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #fff;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .content-header {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title {
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .date-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-selector input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .date-selector button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e1e4e8;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .performance-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            background: #f8f9fa;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4f4dd;
            color: #27ae60;
        }
        
        .status-paused {
            background: #fff3cd;
            color: #f39c12;
        }
        
        .creative-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #f0f2f5;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .metric-value {
            font-weight: 600;
        }
        
        .metric-positive {
            color: #27ae60;
        }
        
        .metric-negative {
            color: #e74c3c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .no-data {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .summary-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .summary-trend {
            font-size: 13px;
            margin-top: 8px;
            color: #666;
        }
        
        .filter-section {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆçµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Metaåºƒå‘Šãƒ¬ãƒãƒ¼ãƒˆ</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="/dashboard" class="nav-item">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <a href="/campaigns" class="nav-item">ğŸ“Š ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ç®¡ç†</a>
                <a href="/ad-performance" class="nav-item active">ğŸ¯ åºƒå‘Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</a>
                <a href="/audience-analysis" class="nav-item">ğŸ‘¥ ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æ</a>
                <a href="/multi-account" class="nav-item">ğŸ”„ ãƒãƒ«ãƒã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a>
                <a href="/budget-scheduling" class="nav-item">â° äºˆç®—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°</a>
                <a href="/alerts" class="nav-item" id="alerts-link">ã‚¢ãƒ©ãƒ¼ãƒˆå†…å®¹</a>
                <a href="/alert-history" class="nav-item">ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´</a>
                <a href="/improvement-tasks" class="nav-item">ç¢ºèªäº‹é …</a>
                <a href="/improvement-strategies" class="nav-item">æ”¹å–„æ–½ç­–</a>
            
            <div class="sidebar-footer" style="position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 20px;">
                <form action="/logout" method="POST" style="margin: 0;">
                    <button type="submit" class="nav-item" style="
                        display: block;
                        width: 100%;
                        padding: 12px 20px;
                        background: rgba(231, 76, 60, 0.1);
                        color: #e74c3c;
                        border: 1px solid rgba(231, 76, 60, 0.2);
                        border-radius: 5px;
                        text-align: left;
                        cursor: pointer;
                        transition: all 0.3s;
                        font-size: 14px;
                        font-weight: 500;
                    " onmouseover="this.style.background='rgba(231, 76, 60, 0.2)'" onmouseout="this.style.background='rgba(231, 76, 60, 0.1)'">
                        ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </form>
            </div>
        </div>
        
        <div class="main-content">
            <div class="content-header">
                <h1 class="content-title">åºƒå‘Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©³ç´°</h1>
                <div class="date-selector">
                    <input type="date" id="dateFrom" />
                    <span>ã€œ</span>
                    <input type="date" id="dateTo" />
                    <button onclick="loadData()">æ›´æ–°</button>
                </div>
            </div>
            
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="tabs">
                <div class="tab active" data-tab="campaigns" onclick="switchTab('campaigns')">
                    ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³
                </div>
                <div class="tab" data-tab="adsets" onclick="switchTab('adsets')">
                    åºƒå‘Šã‚»ãƒƒãƒˆ
                </div>
                <div class="tab" data-tab="ads" onclick="switchTab('ads')">
                    å€‹åˆ¥åºƒå‘Š
                </div>
                <div class="tab" data-tab="audience" onclick="switchTab('audience')">
                    ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æ
                </div>
                <div class="tab" data-tab="funnel" onclick="switchTab('funnel')">
                    ãƒ•ã‚¡ãƒãƒ«åˆ†æ
                </div>
            </div>
            
            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-cards" id="summaryCards">
                <div class="summary-card">
                    <div class="summary-label">ç·æ¶ˆåŒ–é¡</div>
                    <div class="summary-value" id="totalSpend">Â¥0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ç·ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                    <div class="summary-value" id="totalConversions">0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å¹³å‡CPA</div>
                    <div class="summary-value" id="avgCPA">Â¥0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å¹³å‡CTR</div>
                    <div class="summary-value" id="avgCTR">0%</div>
                </div>
            </div>
            
            <!-- ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ“ãƒ¥ãƒ¼ -->
            <div id="campaignsView" class="tab-content">
                <div class="performance-table">
                    <div class="table-header">
                        <h3 class="table-title">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                    </div>
                    <div id="campaignsTableContainer">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- åºƒå‘Šã‚»ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼ -->
            <div id="adsetsView" class="tab-content" style="display: none;">
                <div class="filter-section">
                    <label>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³:</label>
                    <select class="filter-select" id="campaignFilter" onchange="filterAdSets()">
                        <option value="">ã™ã¹ã¦ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                    </select>
                </div>
                <div class="performance-table">
                    <div class="table-header">
                        <h3 class="table-title">åºƒå‘Šã‚»ãƒƒãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                    </div>
                    <div id="adsetsTableContainer">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- å€‹åˆ¥åºƒå‘Šãƒ“ãƒ¥ãƒ¼ -->
            <div id="adsView" class="tab-content" style="display: none;">
                <div class="filter-section">
                    <label>åºƒå‘Šã‚»ãƒƒãƒˆ:</label>
                    <select class="filter-select" id="adsetFilter" onchange="filterAds()">
                        <option value="">ã™ã¹ã¦ã®åºƒå‘Šã‚»ãƒƒãƒˆ</option>
                    </select>
                    <label>ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–:</label>
                    <select class="filter-select" id="creativeFilter" onchange="filterAds()">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="IMAGE">ç”»åƒ</option>
                        <option value="VIDEO">å‹•ç”»</option>
                        <option value="CAROUSEL">ã‚«ãƒ«ãƒ¼ã‚»ãƒ«</option>
                    </select>
                </div>
                <div class="performance-table">
                    <div class="table-header">
                        <h3 class="table-title">å€‹åˆ¥åºƒå‘Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                    </div>
                    <div id="adsTableContainer">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æãƒ“ãƒ¥ãƒ¼ -->
            <div id="audienceView" class="tab-content" style="display: none;">
                <div class="performance-table">
                    <div class="table-header">
                        <h3 class="table-title">ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹åˆ†æ</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px;">
                        <div>
                            <h4>å¹´é½¢åˆ¥</h4>
                            <canvas id="ageChart"></canvas>
                        </div>
                        <div>
                            <h4>æ€§åˆ¥</h4>
                            <canvas id="genderChart"></canvas>
                        </div>
                        <div>
                            <h4>ãƒ‡ãƒã‚¤ã‚¹åˆ¥</h4>
                            <canvas id="deviceChart"></canvas>
                        </div>
                    </div>
                    <div id="audienceTableContainer" style="margin-top: 30px;">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒ•ã‚¡ãƒãƒ«åˆ†æãƒ“ãƒ¥ãƒ¼ -->
            <div id="funnelView" class="tab-content" style="display: none;">
                <div class="performance-table">
                    <div class="table-header">
                        <h3 class="table-title">ãƒ•ã‚¡ãƒãƒ«åˆ†æ</h3>
                    </div>
                    <div style="margin: 30px 0;">
                        <canvas id="funnelChart" style="max-height: 400px;"></canvas>
                    </div>
                    <div id="funnelTableContainer">
                        <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let campaignsData = [];
        let adsetsData = [];
        let adsData = [];
        let audienceData = null;
        let funnelData = null;
        let currentTab = 'campaigns';
        
        // åˆæœŸè¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // æ—¥ä»˜ã®åˆæœŸå€¤ã‚’è¨­å®šï¼ˆéå»7æ—¥é–“ï¼‰
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadData();
        });
        
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tab) {
            currentTab = tab;
            
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
                if (t.dataset.tab === tab) {
                    t.classList.add('active');
                }
            });
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(tab + 'View').style.display = 'block';
            
            // å„ã‚¿ãƒ–ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            if (tab === 'adsets' && adsetsData.length === 0) {
                loadAdSets();
            } else if (tab === 'ads' && adsData.length === 0) {
                loadAds();
            } else if (tab === 'audience' && !audienceData) {
                loadAudienceData();
            } else if (tab === 'funnel' && !funnelData) {
                loadFunnelData();
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿å«ã‚€ï¼‰
            try {
                const response = await fetch(`/api/campaigns-insights?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success && data.campaigns) {
                    campaignsData = data.campaigns;
                    renderCampaignsTable(campaignsData);
                    updateSummaryCards(campaignsData);
                } else if (data.error) {
                    console.log('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', data.error);
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const container = document.getElementById('campaignsTableContainer');
                    container.innerHTML = `<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                const container = document.getElementById('campaignsTableContainer');
                container.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
            
            // ç¾åœ¨ã®ã‚¿ãƒ–ã«å¿œã˜ã¦è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            if (currentTab === 'adsets') {
                loadAdSets();
            } else if (currentTab === 'ads') {
                loadAds();
            } else if (currentTab === 'audience') {
                loadAudienceData();
            } else if (currentTab === 'funnel') {
                loadFunnelData();
            }
        }
        
        // åºƒå‘Šã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAdSets() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            try {
                const response = await fetch(`/api/adsets?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    adsetsData = data.data;
                    if (adsetsData.length > 0) {
                        renderAdSetsTable(adsetsData);
                        updateCampaignFilter();
                    } else {
                        document.getElementById('adsetsTableContainer').innerHTML = '<div class="no-data">Meta APIã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>';
                    }
                } else if (data.error) {
                    document.getElementById('adsetsTableContainer').innerHTML = `<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('åºƒå‘Šã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('adsetsTableContainer').innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }
        
        // å€‹åˆ¥åºƒå‘Šãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAds() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            try {
                const response = await fetch(`/api/ads?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success) {
                    adsData = data.data;
                    renderAdsTable(adsData);
                    updateAdSetFilter();
                }
            } catch (error) {
                console.error('å€‹åˆ¥åºƒå‘Šãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadAudienceData() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            try {
                const response = await fetch(`/api/audience-insights?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    audienceData = data.data;
                    // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã‹ãƒã‚§ãƒƒã‚¯
                    if (Object.keys(audienceData.byAge || {}).length > 0 ||
                        Object.keys(audienceData.byGender || {}).length > 0 ||
                        Object.keys(audienceData.byDevice || {}).length > 0) {
                        renderAudienceCharts();
                        renderAudienceTable();
                    } else {
                        document.getElementById('audienceTableContainer').innerHTML = '<div class="no-data">Meta APIã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>';
                    }
                } else if (data.error) {
                    document.getElementById('audienceTableContainer').innerHTML = `<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('audienceTableContainer').innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadFunnelData() {
            const since = document.getElementById('dateFrom').value;
            const until = document.getElementById('dateTo').value;
            
            try {
                const response = await fetch(`/api/funnel-analysis?since=${since}&until=${until}`);
                const data = await response.json();
                
                if (data.success) {
                    funnelData = data.data;
                    renderFunnelChart();
                    renderFunnelTable();
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ãƒãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderCampaignsTable(campaigns) {
            const container = document.getElementById('campaignsTableContainer');
            
            if (!campaigns || campaigns.length === 0) {
                container.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³å</th>
                            <th>æ¶ˆåŒ–é¡</th>
                            <th>ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³</th>
                            <th>ã‚¯ãƒªãƒƒã‚¯</th>
                            <th>CTR</th>
                            <th>CPM</th>
                            <th>CPC</th>
                            <th>CV</th>
                            <th>CPA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            campaigns.forEach(campaign => {
                html += `
                    <tr>
                        <td>${campaign.name || 'Unknown'}</td>
                        <td class="metric-value">Â¥${(campaign.spend || 0).toLocaleString()}</td>
                        <td>${(campaign.impressions || 0).toLocaleString()}</td>
                        <td>${(campaign.clicks || 0).toLocaleString()}</td>
                        <td class="metric-value">${(campaign.ctr || 0).toFixed(2)}%</td>
                        <td>Â¥${Math.round(campaign.cpm || 0).toLocaleString()}</td>
                        <td>Â¥${Math.round(campaign.cpc || 0).toLocaleString()}</td>
                        <td class="metric-value">${campaign.conversions || 0}</td>
                        <td class="metric-value">Â¥${Math.round(campaign.cpa || 0).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // åºƒå‘Šã‚»ãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderAdSetsTable(adsets) {
            const container = document.getElementById('adsetsTableContainer');
            
            if (!adsets || adsets.length === 0) {
                container.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>åºƒå‘Šã‚»ãƒƒãƒˆå</th>
                            <th>ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</th>
                            <th>ç›®çš„</th>
                            <th>æ¶ˆåŒ–é¡</th>
                            <th>CTR</th>
                            <th>CPM</th>
                            <th>CV</th>
                            <th>CPA</th>
                            <th>ãƒ•ãƒªãƒ¼ã‚¯ã‚¨ãƒ³ã‚·ãƒ¼</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            adsets.forEach(adset => {
                html += `
                    <tr>
                        <td>${adset.name || 'Unknown'}</td>
                        <td>${adset.campaignName || '-'}</td>
                        <td><span class="status-badge status-active">${adset.objective || 'CONVERSIONS'}</span></td>
                        <td class="metric-value">Â¥${(adset.spend || 0).toLocaleString()}</td>
                        <td class="metric-value">${(adset.ctr || 0).toFixed(2)}%</td>
                        <td>Â¥${Math.round(adset.cpm || 0).toLocaleString()}</td>
                        <td class="metric-value">${adset.conversions || 0}</td>
                        <td class="metric-value">Â¥${Math.round(adset.cpa || 0).toLocaleString()}</td>
                        <td>${(adset.frequency || 0).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // å€‹åˆ¥åºƒå‘Šãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderAdsTable(ads) {
            const container = document.getElementById('adsTableContainer');
            
            if (!ads || ads.length === 0) {
                container.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>åºƒå‘Šå</th>
                            <th>åºƒå‘Šã‚»ãƒƒãƒˆ</th>
                            <th>ã‚¿ã‚¤ãƒ—</th>
                            <th>æ¶ˆåŒ–é¡</th>
                            <th>CTR</th>
                            <th>CPM</th>
                            <th>CV</th>
                            <th>CPA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            ads.forEach(ad => {
                const typeIcon = ad.creativeType === 'VIDEO' ? 'ğŸ¥' : 
                               ad.creativeType === 'CAROUSEL' ? 'ğŸ ' : 'ğŸ–¼ï¸';
                html += `
                    <tr>
                        <td>${ad.name || 'Unknown'}</td>
                        <td>${ad.adsetName || '-'}</td>
                        <td><span class="creative-type">${typeIcon} ${ad.creativeType}</span></td>
                        <td class="metric-value">Â¥${(ad.spend || 0).toLocaleString()}</td>
                        <td class="metric-value">${(ad.ctr || 0).toFixed(2)}%</td>
                        <td>Â¥${Math.round(ad.cpm || 0).toLocaleString()}</td>
                        <td class="metric-value">${ad.conversions || 0}</td>
                        <td class="metric-value">Â¥${Math.round(ad.cpa || 0).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderAudienceCharts() {
            if (!audienceData) return;
            
            // å¹´é½¢åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
            const ageCtx = document.getElementById('ageChart').getContext('2d');
            new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(audienceData.byAge || {}),
                    datasets: [{
                        label: 'æ¶ˆåŒ–é¡',
                        data: Object.values(audienceData.byAge || {}).map(d => d.spend),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            
            // æ€§åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
            const genderCtx = document.getElementById('genderChart').getContext('2d');
            new Chart(genderCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(audienceData.byGender || {}).map(g => {
                        if (g === 'male') return 'ç”·æ€§';
                        if (g === 'female') return 'å¥³æ€§';
                        if (g === 'unknown') return 'ä¸æ˜';
                        return g;
                    }),
                    datasets: [{
                        data: Object.values(audienceData.byGender || {}).map(d => d.spend),
                        backgroundColor: ['#667eea', '#764ba2', '#e5e7eb']
                    }]
                }
            });
            
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥ãƒãƒ£ãƒ¼ãƒˆ
            const deviceCtx = document.getElementById('deviceChart').getContext('2d');
            new Chart(deviceCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(audienceData.byDevice || {}).map(d => {
                        if (d === 'desktop') return 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—';
                        if (d === 'mobile' || d === 'mobile_app') return 'ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒª';
                        if (d === 'mobile_web') return 'ãƒ¢ãƒã‚¤ãƒ«Web';
                        return d;
                    }),
                    datasets: [{
                        data: Object.values(audienceData.byDevice || {}).map(d => d.spend),
                        backgroundColor: ['#667eea', '#a855f7', '#ec4899', '#f59e0b']
                    }]
                }
            });
        }
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderAudienceTable() {
            const container = document.getElementById('audienceTableContainer');
            
            if (!audienceData) {
                container.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<h4>å¹´é½¢åˆ¥è©³ç´°</h4><table><thead><tr><th>å¹´é½¢</th><th>æ¶ˆåŒ–é¡</th><th>ã‚¯ãƒªãƒƒã‚¯</th><th>CV</th><th>CTR</th><th>CPA</th></tr></thead><tbody>';
            
            Object.entries(audienceData.byAge || {}).forEach(([age, data]) => {
                html += `
                    <tr>
                        <td>${age}</td>
                        <td>Â¥${(data.spend || 0).toLocaleString()}</td>
                        <td>${(data.clicks || 0).toLocaleString()}</td>
                        <td>${data.conversions || 0}</td>
                        <td>${(data.ctr || 0).toFixed(2)}%</td>
                        <td>Â¥${Math.round(data.cpa || 0).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒãƒ£ãƒ¼ãƒˆæç”»
        function renderFunnelChart() {
            if (!funnelData || !funnelData.funnel) return;
            
            const ctx = document.getElementById('funnelChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funnelData.funnel.stages.map(s => s.name),
                    datasets: [{
                        label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°',
                        data: funnelData.funnel.stages.map(s => s.count),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        
        // ãƒ•ã‚¡ãƒãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderFunnelTable() {
            const container = document.getElementById('funnelTableContainer');
            
            if (!funnelData || !funnelData.funnel) {
                container.innerHTML = '<div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            let html = '<h4>é›¢è„±ãƒã‚¤ãƒ³ãƒˆåˆ†æ</h4><table><thead><tr><th>ã‚¹ãƒ†ãƒ¼ã‚¸</th><th>é›¢è„±ç‡</th></tr></thead><tbody>';
            
            funnelData.funnel.dropoffPoints.forEach(point => {
                const isHighDropoff = point.dropoffRate > 50;
                html += `
                    <tr>
                        <td>${point.stage}</td>
                        <td class="${isHighDropoff ? 'metric-negative' : ''}">${point.dropoffRate.toFixed(1)}%</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
        function updateSummaryCards(campaigns) {
            const totalSpend = campaigns.reduce((sum, c) => sum + (c.spend || 0), 0);
            const totalConversions = campaigns.reduce((sum, c) => sum + (c.conversions || 0), 0);
            const totalClicks = campaigns.reduce((sum, c) => sum + (c.clicks || 0), 0);
            const totalImpressions = campaigns.reduce((sum, c) => sum + (c.impressions || 0), 0);
            
            const avgCPA = totalConversions > 0 ? totalSpend / totalConversions : 0;
            const avgCTR = totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : 0;
            
            document.getElementById('totalSpend').textContent = 'Â¥' + totalSpend.toLocaleString();
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('avgCPA').textContent = 'Â¥' + Math.round(avgCPA).toLocaleString();
            document.getElementById('avgCTR').textContent = avgCTR.toFixed(2) + '%';
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°
        function updateCampaignFilter() {
            const select = document.getElementById('campaignFilter');
            const campaigns = [...new Set(adsetsData.map(a => a.campaignName))];
            
            select.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>';
            campaigns.forEach(campaign => {
                select.innerHTML += `<option value="${campaign}">${campaign}</option>`;
            });
        }
        
        function updateAdSetFilter() {
            const select = document.getElementById('adsetFilter');
            const adsets = [...new Set(adsData.map(a => a.adsetName))];
            
            select.innerHTML = '<option value="">ã™ã¹ã¦ã®åºƒå‘Šã‚»ãƒƒãƒˆ</option>';
            adsets.forEach(adset => {
                select.innerHTML += `<option value="${adset}">${adset}</option>`;
            });
        }
        
        function filterAdSets() {
            const campaignFilter = document.getElementById('campaignFilter').value;
            const filtered = campaignFilter ? 
                adsetsData.filter(a => a.campaignName === campaignFilter) : 
                adsetsData;
            renderAdSetsTable(filtered);
        }
        
        function filterAds() {
            const adsetFilter = document.getElementById('adsetFilter').value;
            const creativeFilter = document.getElementById('creativeFilter').value;
            
            let filtered = adsData;
            if (adsetFilter) {
                filtered = filtered.filter(a => a.adsetName === adsetFilter);
            }
            if (creativeFilter) {
                filtered = filtered.filter(a => a.creativeType === creativeFilter);
            }
            
            renderAdsTable(filtered);
        }
    </script>
</body>
</html>